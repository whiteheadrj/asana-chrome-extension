---
spec: refresh-token
phase: research
task: 0/0
updated: 2026-01-22
---

# Progress: refresh-token

## Original Goal

It appears that after not using the plugin, it makes you reconnect with Asana. The user suspects the refresh token is not being handled properly. After successfully connecting to Asana, the user should NEVER need to reconnect unless they log out. Determine the issue with getting a new token from Asana using the refresh token.

## Completed Tasks

- [x] Research phase complete - research.md created
- [x] 1.1 Add asanaErrorCode property to AuthExpiredError - ec30790
- [x] 1.2 Add AsanaOAuthError interface and parseAsanaError helper - 3ecf6e1
- [x] 1.3 Add RefreshFailureContext interface and logRefreshFailure function - 2984a6d
- [x] 1.4 [VERIFY] Quality checkpoint: pnpm lint && pnpm check-types
- [x] 1.5 Add verifyTokenStorage function - 50043d0
- [x] 1.6 Add retry constants and sleep helper to oauth.ts - 5d200b4
- [x] 1.7 Refactor refreshTokens with retry loop and error handling - 7b1709e
- [x] 1.8 [VERIFY] Quality checkpoint: pnpm lint && pnpm check-types
- [x] 1.9 POC manual validation via test harness - c7a2409
- [x] 2.1 Extract error type classification logic - 1861a08
- [x] 2.2 Add isRetryableError helper for clarity - 867f61f
- [x] 2.3 [VERIFY] Quality checkpoint: pnpm lint && pnpm check-types
- [x] 3.1 Add tests for parseAsanaError helper - d7d60ec
- [x] 3.2 Add tests for retry behavior on network errors
- [x] 3.3 Add tests for no-retry on auth errors
- [x] 3.4 [VERIFY] Quality checkpoint: pnpm lint && pnpm check-types && pnpm test
- [x] 3.5 Add tests for storage verification
- [x] 3.6 Add tests for logging output
- [x] 3.7 Add E2E test for token refresh flow
- [x] 3.8 Verify test coverage meets target

## Current Task

Awaiting next task

### Task 3.8: Verify Test Coverage Meets Target
- Initial coverage: 89.18% (just below 90% target)
- Uncovered lines: 94 (429 rate limit), 525 (unreachable throw), 595-596 (verifyTokenStorage null case)
- Added tests for `isRetryableError` helper (6 tests covering 429, 500, 503, 400, 401, 200)
- Added tests for `verifyTokenStorage` helper (5 tests covering match, no tokens, mismatch cases)
- Added test for 429 rate limit retry behavior in refreshTokens
- Final coverage: **91.21%** statements, 82.75% branch, 100% functions, 91.09% lines
- All 336 tests passing (12 new tests added)

### Task 3.7: E2E Test for Token Refresh Flow
- Created `/Users/rjwhitehead/asana-plugin/e2e/oauth-refresh.e2e.test.ts`
- Documented E2E testing limitations for token refresh:
  1. Service worker requests cannot be intercepted by Playwright page.route()
  2. chrome.storage.local is not accessible from Playwright test context
  3. Asana API mocking would require proxy server infrastructure
  4. Token refresh flow requires valid OAuth credentials
- Added 5 E2E tests that verify what IS testable:
  1. "extension loads with OAuth refresh token functionality" - verifies extension loads
  2. "extension manifest includes OAuth permissions" - verifies storage permission present
  3. "built extension includes OAuth module with retry constants" - verifies MAX_REFRESH_RETRIES, BASE_DELAY_MS, parseAsanaError, logRefreshFailure, verifyTokenStorage in built code
  4. "built extension includes exponential backoff calculation" - verifies Math.pow(2, ...) pattern
  5. "documents E2E testing limitations" - meta-test documenting why full E2E not feasible
- All 14 E2E tests passing (9 existing + 5 new)

### Task 3.6: Logging Output Tests
- Two tests added for verifying diagnostic logging output
- Test 1: "logs failure with timestamp, status, and error code" - verifies auth error logging contains timestamp, HTTP status (400), error code (invalid_grant), and recoverable (false)
- Test 2: "logs retry attempts with attempt number" - verifies retry logging shows "Attempt: 1/4" format
- Used vi.spyOn(console, 'error') to capture log output
- All 55 tests now passing

## Learnings

### POC Validation: 1.9
- All 38 existing tests pass - no regressions from new behavior
- Build succeeds
- Phase 1 POC complete: AuthExpiredError enhanced, retry logic, error parsing, logging, storage verification all working

### Verification: 1.8 [VERIFY] Quality checkpoint
- Status: PASS
- Commands: pnpm lint (exit 0), pnpm check-types (exit 0)
- No fixes needed

### Requirements Phase Discoveries
- Existing `errors.ts` has `isRecoverableError()` function - can leverage for retry decisions
- `wrapFetchError()` already detects network vs auth errors - extend rather than replace
- Storage functions don't verify writes - no read-after-write check
- Error codes defined in `ErrorCode` type - may need to extend for Asana-specific codes
- `AuthExpiredError` doesn't include Asana error code - adding property is backward compatible

### External Research Findings
- Asana access tokens expire in 1 hour (3600 seconds)
- Asana refresh tokens NEVER expire - valid indefinitely while app is authorized
- Token refresh endpoint: `POST https://app.asana.com/-/oauth_token`
- Asana returns specific error codes: `invalid_grant`, `invalid_client`, `unauthorized_client`

### Codebase Analysis
- oauth.ts `refreshTokens` function has correct parameters
- `getValidAccessToken` proactively refreshes when token expires in <5 minutes (good)
- `isAuthenticated` correctly returns true even with expired access token (good)

### Identified Root Causes
1. **Missing error response parsing** - refreshTokens doesn't parse Asana's error body to determine actual failure reason
2. **Blanket 400/401 handling** - All 400 errors treated as "session expired" when could be `invalid_client`
3. **No error logging** - Cannot diagnose why refresh fails in production
4. **No retry logic** - Transient network failures immediately trigger re-auth
5. **No storage verification** - Token persistence not verified after chrome.storage.local.set()

### Quality Commands Discovered
- Lint: `pnpm lint`
- TypeCheck: `pnpm check-types`
- Test: `pnpm test`
- E2E: `pnpm test:e2e`
- Build: `pnpm build`
- Local CI: `pnpm lint && pnpm check-types && pnpm test && pnpm build`

## Blockers

None currently.

## Next

Task 4.1 [VERIFY] Full local CI: pnpm lint && pnpm check-types && pnpm test && pnpm build

## Design Phase Discoveries

- asana-api.ts already has retry pattern (MAX_RETRIES=3, exponential backoff) - mirror for consistency
- calculateBackoffDelay helper exists - can reuse pattern
- sleep() helper exists in asana-api.ts - inline or extract to shared
- AuthExpiredError needs only one new property (asanaErrorCode) - minimal change
- Storage functions (setTokens/getTokens) are simple wrappers - verification straightforward
- Response.clone() needed if parsing error body (body can only be read once)
- Existing test mocks for fetch work well - extend for retry scenarios

## Task Planning Discoveries

- Task ordering: errors.ts must be modified first (AuthExpiredError), then oauth.ts can use updated class
- Quality checkpoints inserted after every 2-3 tasks to catch type errors early
- POC phase (tasks 1.1-1.9) focuses on getting retry + logging working before tests
- Existing oauth.test.ts has good patterns for mocking fetch - tests can extend these
- parseAsanaError may need to be exported for direct unit testing (or test via refreshTokens)
- E2E test feasibility unknown - may need to mock at network level or document limitation
- Total retry time: 1+2+4 = 7 seconds, well within 10s NFR target

### Verification: 1.4 [VERIFY] Quality checkpoint
- Status: PASS
- Commands: pnpm lint (exit 0), pnpm check-types (exit 0)
- No fixes needed

### Verification: 2.3 [VERIFY] Quality checkpoint
- Status: PASS
- Commands: pnpm lint (exit 0), pnpm check-types (exit 0)
- No fixes needed

### Task 3.2: Retry Behavior Tests
- Used vi.useFakeTimers() and vi.advanceTimersByTimeAsync() to avoid waiting for real backoff delays
- For tests expecting rejection, use .catch() pattern to capture error and avoid unhandled rejection warnings
- Three retry tests added: network error then succeeds, 5xx then succeeds, max retries exhausted
- All 48 tests now passing

### Task 3.3: No-Retry Auth Error Tests
- Two tests added verifying auth errors fail immediately (no retries)
- Tests use mock with clone() to support parseAsanaError which clones response
- "does not retry on invalid_grant" - verifies fetch called once, asanaErrorCode is 'invalid_grant'
- "does not retry on invalid_client" - verifies fetch called once, userMessage contains "Configuration error"
- All 50 tests now passing

### Verification: 3.4 [VERIFY] Quality checkpoint
- Status: PASS
- Commands: pnpm lint (exit 0), pnpm check-types (exit 0), pnpm test (exit 0)
- Tests: 8 test files, all passed
- No fixes needed

### Task 3.5: Storage Verification Tests
- Added 3 tests for storage verification behavior in refreshTokens
- Test 1: "calls getTokens after setTokens for verification" - verifies storage read-after-write
- Test 2: "logs warning when storage verification fails" - mocks getTokens to return different values, verifies console.warn called with '[OAuth]' prefix
- Test 3: "continues without error when storage verification fails" - same mock setup, verifies function still returns tokens (doesn't throw)
- Mocked chromeMock.storage.local.get to simulate storage returning different tokens than expected
- All 53 tests now passing
