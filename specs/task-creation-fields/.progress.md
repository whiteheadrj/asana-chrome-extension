---
spec: task-creation-fields
phase: research
task: 0/0
updated: 2026-01-23
---

# Progress: task-creation-fields

## Original Goal

I want the ability to set the assignee, but to have the option to have it be blank as well. Include this field in the defaulting logic.

I want the ability to set the due date, but have the ability for it to be blank.

In the note, if it is from an email include the following information if available: sender name, sender email, date received, subject, email account that received it.

Also if it is an email include a search string I can use in the appropriate email client: https://support.microsoft.com/en-us/office/how-to-search-in-outlook-d824d1e9-a255-4c8a-8553-276fb895a8da or https://support.google.com/mail/answer/7190?hl=en&co=GENIE.Platform%3DAndroid

## Completed Tasks

- [x] Research phase complete - research.md created
- [x] 1.1 Add AsanaUser type and extend CreateTaskPayload - c27880e
- [x] 1.2 Implement getUsers and getCurrentUser API functions
- [x] 1.3 Extend createTask to include assignee and due date fields
- [x] 1.4 [VERIFY] Quality checkpoint: types and API - PASS
- [x] 1.5 Add GET_USERS handler to service worker
- [x] 1.6 Add getSenderDetails and getEmailDate to Gmail content script
- [x] 1.7 Add getSenderDetails and getEmailDate to Outlook content script
- [x] 1.8 [VERIFY] Quality checkpoint: content scripts - PASS
- [x] 1.9 Create email-search.ts with search string builders
- [x] 1.10 Add assignee dropdown and due date inputs to popup HTML
- [x] 1.11 Add CSS styles for new form elements
- [x] 1.12 Wire up assignee dropdown and due date in popup.ts
- [x] 1.13 Enhance notes generation with email metadata and search string
- [x] 1.14 POC Checkpoint - E2E validation - a1c1e56
- [x] 2.1 Extract assignee loading into dedicated function
- [x] 2.2 Add error handling for users API
- [x] 2.3 [VERIFY] Quality checkpoint: popup refactoring - PASS
- [x] 2.4 Extract date formatting helpers - 9a5209a
- [x] 2.5 Add multiple selector fallbacks for email date extraction - f62a042
- [x] 2.6 [VERIFY] Quality checkpoint: refactoring complete - PASS
- [x] 3.1 Add unit tests for email-search.ts
- [x] 3.2 Add unit tests for getUsers and getCurrentUser

## Current Task

Awaiting next task

## Task 3.1 Implementation Notes
- Created email-search.test.ts with 41 comprehensive unit tests
- Tests cover: buildGmailSearchString with all params, missing params (each combo)
- Tests cover: buildOutlookSearchString with all params, missing params (each combo)
- Tests cover: Date format conversion (ISO to Gmail YYYY/MM/DD, ISO to Outlook M/D/YYYY)
- Tests cover: Special character escaping in subject (double quotes)
- Tests cover: Cross-function comparison (Gmail vs Outlook format differences)
- All tests pass on first run

### Verification: 2.3 [VERIFY] Quality checkpoint: popup refactoring
- Status: PASS
- Commands: pnpm lint (exit 0), pnpm check-types (exit 0)
- No fixes needed - all checks passed on first run

## Learnings

### Verification: 1.8 [VERIFY] Quality checkpoint: content scripts
- Status: PASS
- Commands: pnpm lint (exit 0), pnpm check-types (exit 0)
- No fixes needed - all checks passed on first run

### Research Phase Discoveries

- **Asana API supports both fields**: `assignee` (user GID), `due_on` (YYYY-MM-DD date)
- **Users endpoint available**: `GET /workspaces/{workspace_gid}/users` returns users in workspace
- **Email date NOT extracted**: Neither Gmail nor Outlook content scripts currently extract received date
- **Sender extraction needs enhancement**: Currently returns name OR email, need both separately
- **Gmail search syntax**: `from:email subject:"text" after:YYYY/MM/DD before:YYYY/MM/DD`
- **Outlook search syntax**: `from:"email" subject:"text" received:M/D/YYYY`
- **Defaulting pattern exists**: LastUsedSelections stores workspace, project, section - extend for assignee
- **Note generation pattern exists**: noteParts array joined with `\n\n` in popup.ts

### Requirements Phase Discoveries

- **Sender extraction split needed**: Gmail uses `span.gD` with both textContent (name) and `email` attribute - need to return both
- **Outlook sender format**: Returns "Name<email@domain.com>" - need to parse both parts
- **Due date defaulting NOT requested**: User wants assignee to persist, but due date can reset to blank each session
- **Account email Outlook gap**: Outlook content script doesn't extract receiving account email (Gmail does)
- **Search string date formats differ**: Gmail uses `YYYY/MM/DD`, Outlook uses `M/D/YYYY` (no leading zeros)

### Quality Commands

- Lint: `pnpm lint`
- TypeCheck: `pnpm check-types`
- Test: `pnpm test`
- E2E: `pnpm test:e2e`
- Build: `pnpm build`
- Local CI: `pnpm lint && pnpm check-types && pnpm test && pnpm build`

### Key Implementation Gaps Identified

1. `getEmailDate()` function missing from both content scripts
2. Sender name vs email not separated - need both for search strings
3. No `getUsers()` API function in asana-api.ts
4. No user caching pattern (similar to projects/tags)
5. CreateTaskPayload missing `assignee` and `due_on` fields
6. LastUsedSelections missing `assigneeGid` field
7. Popup UI missing assignee dropdown and due date input

## Task 2.4 Implementation Notes
- Created `formatDateForAsana(date, time)` that returns `{ due_on?: string; due_at?: string }`
- Created `formatDateHumanReadable(isoDate)` that returns formatted date string (e.g., "Thursday, January 23, 2026")
- `formatDateForAsana` handles timezone conversion: local time -> UTC via `Date.toISOString()`
- Refactored `handleSubmitTask` to use `formatDateForAsana` with `Object.assign(payload, dateFields)`
- Refactored email metadata notes to use `formatDateHumanReadable`
- Both helpers placed in new "Date Formatting Helpers" section above UI Helpers

## Blockers

None currently.

## Task 3.2 Implementation Notes
- Added 5 new unit tests to asana-api.test.ts for user-related functions
- getUsers tests: fetches users for workspace with correct endpoint, returns empty array for empty workspace, requests correct opt_fields
- getCurrentUser tests: fetches from /users/me endpoint, requests correct opt_fields
- Tests follow existing patterns using createMockResponse helper and vi.fn() mocks
- All 37 tests pass (32 existing + 5 new)

## Next

Task 3.3 [VERIFY] Quality checkpoint: API tests (Phase 3: Testing)

### Verification: 2.6 [VERIFY] Quality checkpoint: refactoring complete
- Status: PASS
- Commands: pnpm lint (exit 0), pnpm check-types (exit 0), pnpm test (exit 0)
- Test results: 8 test files, 336 tests passed
- No fixes needed - all checks passed on first run

## Task 2.5 Implementation Notes
- Gmail: Enhanced from 4 to 8 fallback selectors for date extraction
  - Added: `.ade .ads` (expanded email header), `td.xY span.xW` (list view), `.ii.gt .gK span` (message content), `[data-tooltip][data-message-id]` (tooltip)
  - Added data-tooltip attribute checking for date values
  - Each selector now logs debug message on failure
- Outlook: Enhanced from 3 to 6 date selectors + added title attribute fallback
  - Added: `span[id*="ReceivedDateTime"]`, `div[class*="MessageHeader"] time`, `span[class*="dateTimeLine"]`
  - Added separate Method 4 for title attribute checking: `[title*="Sent:"]`, `[title*="Received:"]`, `span[title]`
  - Improved aria-label selectors to also check `Sent:` and `Received:` variants
  - Each selector/method now logs debug message on failure for better debugging

## Task 2.2 Implementation Notes
- getUsers failure: dropdown stays disabled, title attribute shows error message, logs warning, allows task creation with unassigned
- getCurrentUser failure (already handled in fetchCurrentUser): falls back to first user in list, or unassigned
- Added Priority 3 fallback: when currentUser is null, default to first user in list
- Used existing getErrorMessage() function for user-friendly error messages
- Non-blocking error handling: warns but doesn't prevent task creation (unassigned is a valid state)

## Task 2.1 Implementation Notes
- Created `fetchCurrentUser()` function that attempts to call GET_CURRENT_USER message
- Falls back to null gracefully if handler not implemented (for forward compatibility)
- Created `loadAndDefaultAssignee(workspaceGid, lastUsed?)` as the main entry point
- Loads users and current user in parallel for better performance
- Priority for default assignee: lastUsed.assigneeGid > currentUserGid > unassigned
- Removed deprecated `loadUsers()` wrapper, updated all call sites

## Task 1.13 Implementation Notes
- Imported buildGmailSearchString and buildOutlookSearchString from ./email-search
- Enhanced notes to include email metadata: senderName, senderEmail, emailDate (human-readable), emailSubject, accountEmail (Gmail only)
- Added search string based on email client (Gmail vs Outlook detection via pageUrl)
- Metadata only added when state.contentType === 'email'
- Date formatted using toLocaleDateString for human readability
- Search string formatted as "Search in [Gmail/Outlook]:\n{search_string}"

## Task Planning Discoveries

- **31 total tasks**: Phase 1 (14 POC), Phase 2 (6 refactoring), Phase 3 (8 testing), Phase 4 (3 quality gates)
- **Phase 1 POC complete**: All 14 tasks done, extension builds successfully, ready for manual E2E testing
- **Quality checkpoints**: Inserted every 2-3 tasks throughout all phases for early issue detection
- **E2E validation in POC**: Task 1.14 requires manual browser testing with built extension
- **Key dependency chain**: types -> API -> service worker -> popup wiring
- **Parallel loading**: Users and projects load simultaneously on workspace change
- **Date format complexity**: Gmail uses YYYY/MM/DD, Outlook uses M/D/YYYY - handled in email-search.ts
- **Backward compatibility**: Keep existing emailSender field while adding new senderName/senderEmail

## Design Phase Discoveries

- **Parallel loading opportunity**: Users and projects can load simultaneously on workspace change
- **Backward compatibility needed**: Existing `emailSender` field must remain for compat, add new `senderName`/`senderEmail`
- **Time picker complexity**: Separate checkbox + time input simpler than combined datetime picker
- **Search string in notes**: Cleaner than separate field, matches user request
- **Due date not persisted**: User only requested assignee persistence, due date resets each session
- **getCurrentUser() needed**: For "me" default, use Asana's `/users/me` endpoint
- **Type union extension**: GET_USERS follows existing ExtensionMessage pattern exactly
- **Cache key pattern**: `CACHE_KEYS.USERS(workspaceGid)` matches existing projects/tags pattern

### Verification: 1.4 [VERIFY] Quality checkpoint: types and API
- Status: PASS
- Commands: pnpm lint (exit 0), pnpm check-types (exit 0)
- No fixes needed - all checks passed on first run

### Task 1.12 Implementation Notes
- Added DOM element references for assigneeSelect, dueDateInput, btnToday, btnTomorrow, includeTimeCheckbox, dueTimeInput
- Extended PopupLocalState with users, currentUserGid, selectedAssigneeGid, dueDate, dueTime, senderName, senderEmail, emailDate
- Created loadUsers() function following loadProjects pattern
- Created populateAssigneeDropdown() and resetAssigneeDropdown() functions
- Users now load in parallel with projects on workspace change (Promise.all)
- Today/Tomorrow buttons set date using toISOString().split('T')[0]
- Include time checkbox enables/disables time input
- handleSubmitTask includes assignee, due_on/due_at in payload
- saveLastUsedSelections includes assigneeGid for persistence
- Note: currentUserGid defaulting infrastructure is in place but requires GET_CURRENT_USER message type/handler which was not part of this task's scope (types.ts and service-worker.ts are out of scope)
