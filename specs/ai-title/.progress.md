---
spec: ai-title
phase: tasks
task: 7/32
updated: 2026-01-19T17:00:00Z
---

# Progress: ai-title

## Original Goal

Currently we are using AI to suggest the title of the task. It is not very useful. We need to take into consideration the email subject and contents of the email to recommend the title. If it is just a web page use the page contents for title recommendation.

## Completed Tasks

- [x] Research phase complete - research.md created
- [x] Requirements phase complete - requirements.md created
- [x] Design phase complete - design.md created
- [x] 1.1 Extend AIInput type with new fields
- [x] 1.2 Extend GmailEmailInfo type
- [x] 1.3 Extend OutlookEmailInfo type
- [x] 1.4 Add getEmailBody() to Gmail content script
- [x] 1.5 Add getEmailSender() to Gmail content script
- [x] 1.6 Update Gmail message listener to include new fields
- [x] 1.7 Add getEmailBody() to Outlook content script
- [x] 1.8 Enhance getSenderInfo() in Outlook content script - 7fac331
- [x] 1.9 Update Outlook message listener to include new fields
- [x] 1.10 Fix pageTitle bug in popup
- [x] 1.11 Add state fields for new email data
- [x] 1.12 Update requestPageInfo() to capture new fields
- [x] 1.13 Add page content extraction for non-email pages
- [x] 1.14 Update generateAiSuggestion() to pass new data to AI
- [x] V3 [VERIFY] Quality checkpoint: popup changes
- [x] 1.15 Improve SYSTEM_PROMPT for action-oriented titles
- [x] 1.16 Update buildUserPrompt() for new fields
- [x] 1.17 Update confidence calculation for new inputs - e788e7d
- [x] 1.18 POC Checkpoint - Build and manual verification - pending
- [x] 2.1 Extract truncate helper function - already existed
- [x] 2.2 Add error handling to content script extraction functions
- [x] 2.3 Add logging for DOM selector debugging
- [x] V5 [VERIFY] Quality checkpoint: refactoring complete - PASS
- [x] 3.1 Unit tests for getEmailBody() in Gmail
- [x] 3.2 Unit tests for getEmailSender() in Gmail
- [x] 3.3 Unit tests for getEmailBody() in Outlook

## Current Task

- [x] 3.4 Unit tests for buildUserPrompt() with new fields - complete

## Learnings

### Task 3.4: Unit tests for buildUserPrompt() with new fields
- Added 10 test cases for buildUserPrompt() (exceeds 8+ requirement)
- Tests cover: emailBody inclusion, emailSender inclusion, pageContent for webpage, pageContent exclusion for email
- Tests verify truncation: emailBody at 1000 chars, pageContent at 2000 chars, selectedText at 500 chars
- Tests verify selectedText labeled as "primary" and takes priority
- Tests verify pageTitle skipped when equals emailSubject
- Tests verify pageTitle included when different from emailSubject
- Tested via generateTaskName by mocking fetch and inspecting request body
- buildUserPrompt is not exported, so tested indirectly through generateTaskName API

### Verification: V6 [VERIFY] Quality checkpoint: content script tests
- Status: PASS
- Commands: pnpm test (0)
- Results: 249 tests passed, 0 failed (7 test files)
- Content script tests: gmail-content.test.ts (56 tests), outlook-content.test.ts (44 tests)
- Duration: 881ms

### Task 3.3: Unit tests for getEmailBody() in Outlook
- Added 12 test cases for getEmailBody() function (exceeds 5+ requirement)
- Tests cover: ConversationReadingPane selector, .XbIp4.jmmB7.GNqVo class selector, aria-label="Message body" selector
- Tests verify fallback logic: primary selector is used when multiple match
- Tests verify undefined returned when all selectors fail, empty container, no text content, whitespace-only
- Tests verify truncation at 1000 chars (over, under, and exact boundary)
- Tests verify error handling returns undefined on DOM query error
- Reused happy-dom environment from Gmail tests

### Task 3.2: Unit tests for getEmailSender() in Gmail
- Added 14 test cases for getEmailSender() function (exceeds 5+ requirement)
- Tests cover: span.gD textContent and email attribute, [email] selector, span[data-hovercard-id] with email extraction
- Tests verify preference: name from textContent over raw email from attribute
- Tests verify undefined returned when all selectors fail, empty container, whitespace-only, and on DOM errors
- Reused happy-dom environment from getEmailBody tests

### Task 3.1: Unit tests for getEmailBody() in Gmail
- Added 13 test cases for getEmailBody() function (exceeds 5+ requirement)
- Used happy-dom for DOM testing (jsdom had ESM compatibility issues with vitest)
- Tests cover: primary selector, fallback selectors, undefined cases, truncation at 1000 chars, error handling
- Test file uses `@vitest-environment happy-dom` directive for per-file environment override
- happy-dom is more lightweight and compatible with vitest than jsdom

### Verification: V5 [VERIFY] Quality checkpoint: refactoring complete
- Status: PASS
- Commands: pnpm check-types (0), pnpm lint (0)
- Duration: ~2s
- All refactoring phase changes (truncate helper, error handling, debug logging) compile cleanly with no type or lint errors

### Task 2.3: Add logging for DOM selector debugging
- Added console.debug for each individual selector that fails (Gmail: body 3 selectors, sender 3 methods; Outlook: body 3 selectors, sender 4+2 selectors)
- Added console.debug for successful extraction showing which specific selector worked
- Existing error handling preserved - added failure logging within loops, success logging on early returns
- Debug logging pattern: `[Asana Extension] {Platform} {field} selector failed: {selector}` and `[Asana Extension] {Platform} {field} extracted using selector: {selector}`

### Task 2.2: Add error handling to content script extraction functions
- Wrapped all DOM extraction functions in try-catch blocks
- Gmail: getEmailBody() and getEmailSender() now return undefined on any error
- Outlook: getEmailBody() and getSenderInfo() now return undefined on any error
- Debug messages logged on both extraction failures and errors
- Graceful degradation ensures extension continues working even if DOM queries throw

### Task 2.1: Extract truncate helper function
- Task already completed during 1.16 - truncate() helper already exists in ai.ts
- Function handles edge case: returns original text if length <= maxLength
- Function adds ellipsis when truncating: text.substring(0, maxLength) + '...'
- Already in use by buildUserPrompt() for selectedText (500), emailBody (1000), pageTitle (100), pageContent (2000)

### Task 1.18: POC Checkpoint
- Build succeeded with no errors
- Extension output to dist/ directory
- All POC phase tasks complete: types, Gmail, Outlook, popup, AI module
- Extension ready for manual testing

### Verification: V4 [VERIFY] Quality checkpoint: AI module changes
- Status: PASS
- Commands: pnpm check-types (0), pnpm lint (0)
- Duration: ~2s
- All AI module changes (SYSTEM_PROMPT, buildUserPrompt, confidence calculation) compile cleanly with no type or lint errors

### Task 1.17: Confidence calculation update
- Added emailBody with length > 50 as high confidence criteria
- Preserves existing high confidence triggers: emailSubject, selectedText > 20 chars
- More context = higher confidence: emailBody provides substantial context for better task title generation

### Task 1.16: buildUserPrompt() update
- Created truncate() helper for consistent text truncation
- Priority order implemented: selectedText (500) > emailSubject > emailSender > emailBody (1000) > pageTitle (100) > pageContent (2000)
- pageContent only included when contentType === 'webpage'
- pageTitle skipped when equals emailSubject to avoid duplication
- selectedText labeled as "primary" to indicate user intent signal

### Verification: V3 [VERIFY] Quality checkpoint: popup changes
- Status: PASS
- Commands: pnpm check-types (0), pnpm lint (0)
- Duration: ~2s
- All popup changes compile cleanly with no type or lint errors

### Verification: V2 [VERIFY] Quality checkpoint: Outlook changes
- Status: PASS
- Commands: pnpm check-types (0), pnpm lint (0)
- Duration: ~2s
- All Outlook content script changes compile cleanly

### Verification: V1 [VERIFY] Quality checkpoint: types and Gmail changes
- Status: PASS
- Commands: pnpm check-types (0), pnpm lint (0)
- Duration: ~3s
- All type definitions and Gmail content script changes compile cleanly

- Current AI title generation only uses `pageTitle`, `selectedText`, `emailSubject`, `pageUrl` - missing email body content
- Gmail content script already extracts subject via DOM selectors but not email body
- Outlook content script extracts subject but not email body
- Bug found: popup uses `document.title` which is popup's title, not page title
- AIInput type needs extension with `emailBody`, `emailSender`, `pageContent`, `contentType`
- Best practice: XML-structured prompts work well with Claude
- Best practice: Put source text ABOVE prompt (recency effect)
- Best practice: Start task titles with action verbs (Review, Follow up, Schedule)
- Best practice: Preserve specifics (names, dates, invoice numbers) in titles
- Token budget consideration: Email bodies should be truncated to ~1000 chars
- DOM selectors for email body extraction may need maintenance as Gmail/Outlook update their UIs
- Haiku model is adequate but larger prompts = slower/costlier calls
- Requirements: Selected text should take priority when present (user intent signal)
- Requirements: Graceful degradation at every extraction point is critical
- Requirements: contentType discrimination helps prompt select appropriate extraction strategy
- Requirements: Edge case handling needed for confidential emails, empty bodies, multi-language
- Requirements: Success criteria should include action verb presence rate
- Design: Use chrome.scripting.executeScript for page content extraction to avoid new content scripts
- Design: Outlook already has getSenderInfo() - enhance with fallback selectors rather than rewrite
- Design: Gmail body selectors: .a3s.aiL, [data-message-id] .ii.gt, .adn.ads
- Design: Outlook body selectors: [data-app-section="ConversationReadingPane"], .XbIp4.jmmB7.GNqVo
- Design: Plain text prompt works better than XML for this use case with Haiku
- Design: 15 implementation steps identified, mostly modifications to existing files

## Blockers

- None currently

## Next

Task 3.5 Unit tests for confidence calculation with emailBody

## Task Planning Insights

- 32 total tasks: 18 POC, 3 refactoring, 7 testing, 4 quality gates
- 8 [VERIFY] checkpoints distributed throughout all phases
- POC phase is self-contained: types first, then Gmail, then Outlook, then popup, then AI module
- E2E tests may require additional Playwright/Puppeteer setup for Chrome extension testing
- Integration tests can mock chrome.* APIs using existing patterns from service-worker.integration.test.ts
- All tasks have automated verification commands - no manual testing required
- DOM selector risk mitigated by multiple fallback selectors and debug logging
